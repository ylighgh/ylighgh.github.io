=== MySQL集群

[cols=2*] 
|===

|主节点
|10.0.2.20

|从节点
|10.0.2.30
|===

==== 主从备份

**主节点配置**

.修改 `my.cnf` 文件

[source,bash]
----
vim /etc/my.cnf
[mysqld]
#记录操作日志
log-bin=mysql-bin
#不同步mysql系统数据库
binlog-ignore-db = mysql
#数据库集群的节点id
server-id=20
----

.修改系统配置
[source,bash]
----
# 重启数据库服务，使配置文件生效
systemctl restart mariadb
# 在主节点创建一个slave用户连接节点mysql2，并赋予从节点同步主节点数据库权限
mysql -uroot -pgeek -e 'grant replication slave on *.* to slave@"10.0.2.30" identified by "geek";flush privileges;'
----


**从节点配置**

.修改 `my.cnf` 文件

[source,bash]
----
vim /etc/my.cnf
[mysqld]
#记录操作日志
log-bin=mysql-bin
#不同步mysql系统数据库
replicate-ignore-db=mysql
#数据库集群的节点id
server-id=30
----

.修改系统配置


在主节点使用 `show master stauts;` 查询

`master_log_file` 和 `master_log_pos`

[source,bash]
----
#重启数据库服务，使配置文件生效
systemctl restart mariadb

#配置从节点连接主节点的信息，并开启从节点服务
mysql -uroot -pgeek -e 'change master to master_host="10.0.2.20",master_user="slave",master_password="geek",master_log_file="xxxx",master_log_pos=xxxx;start slave;flush privileges;'
----

.验证从节点服务是否开启
在从节点服务器执行命令: `mysql -uroot -pgeek -e 'show slave status\G'``,如果 `Slave_IO_Running` 和 `Slave_SQL_Running` 的状态都为YES，则节点服务开启成功
[source,bash]
----
[root@ylighgh ~]# mysql -uroot -pgeek -e'show slave status\G'
*************************** 1. row ***************************
            ...
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
            ...
----

==== 主主模式


**主节点配置**

.修改 `my.cnf` 文件

[source,bash]
----
vim /etc/my.cnf
[mysqld]
#记录操作日志
log-bin=mysql-bin
#不同步mysql,information_scheme系统数据库
binlog-ignore-db=mysql
binlog-ignore-db=information_scheme 
#数据库集群的节点id
server-id=20
----

.修改系统配置

使用 `show master stauts;` 查询信息

修改 `master_log_file` 和 `master_log_pos`

[source,bash]
----
# 重启数据库服务，使配置文件生效
systemctl restart mariadb
# 在主节点创建一个slave用户连接节点mysql2，并赋予从节点同步主节点数据库权限
mysql -uroot -pgeek -e 'grant replication slave on *.* to slave@"10.0.2.30" identified by "geek";flush privileges;'

mysql -uroot -pgeek -e 'change master to master_host="10.0.2.30",master_user="slave",master_password="geek",master_log_file="xxxx",master_log_pos=xxxx;start slave;flush privileges;'
----


**从节点配置**

.修改 `my.cnf` 文件

[source,bash]
----
vim /etc/my.cnf
[mysqld]
#记录操作日志
log-bin=mysql-bin
#不同步mysql,information_scheme系统数据库
binlog-ignore-db=mysql
binlog-ignore-db=information_scheme 
#数据库集群的节点id
server-id=30
----

.修改系统配置

使用 `show master stauts;` 查询信息

修改 `master_log_file` 和 `master_log_pos`

[source,bash]
----
#重启数据库服务，使配置文件生效
systemctl restart mariadb
#配置从节点连接主节点的信息，并开启从节点服务
mysql -uroot -pgeek -e 'grant replication slave on *.* to slave@"10.0.2.20" identified by "geek";flush privileges;'


mysql -uroot -pgeek -e 'change master to master_host="10.0.2.20",master_user="slave",master_password="geek",master_log_file="xxxx",master_log_pos=xxxx;start slave;flush privileges;'
----

.验证主从节点服务是否开启
在主从节点服务器执行命令: `mysql -uroot -pgeek -e 'show slave status\G'``,如果 `Slave_IO_Running` 和 `Slave_SQL_Running` 的状态都为YES，则节点服务开启成功
[source,bash]
----
[root@ylighgh ~]# mysql -uroot -pgeek -e'show slave status\G'
*************************** 1. row ***************************
            ...
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
            ...
----
